{% extends 'base.html.twig' %}
{% import '@App/theme1/breadcrumb.html.twig' as breadcrumb %}

{% set _title = 'Registro Fondos' %}
{% set _main_title = 'Nuevo' %}
{% set _section =  'registro_fondos_index'%}

{% block _breadcrumb %}
    {{ breadcrumb.show2(_title,_section,'Nuevo') }}
{% endblock %}

{% block _main %}
    {{ include('registro_fondos/_form.html.twig') }}
{% endblock %}

{% block _body_tools %}
    {% include 'crud/_new_links_ico.html.twig' with {'route_base':'registro_fondos'} %}
{% endblock %}

{% block _main_footer %}
    {% include 'crud/_new_links.html.twig' with {'route_base':'registro_fondos'} %}
{% endblock %}

{% block stylesheets %}
{% endblock %}

{% block javascripts %}
    <script src="{{ asset('js/select2.js') }}"></script>
    <script src="{{ asset('js/flatpickr.js') }}"></script>
    <script>
        let dniTxt = document.getElementById('registro_fondos_dni');
        let nombresTxt = document.getElementById('registro_fondos_nombreSocio');
        let baseSocialTxt = document.getElementById('registro_fondos_baseSocial');
        let tipoSocioTxt = document.getElementById('registro_fondos_tipoSocio');
        nombresTxt.readOnly = true;
        baseSocialTxt.readOnly = true;
        tipoSocioTxt.readOnly = true;
    </script>
    <script>
        // Modificar para cuando se implementen las APIs del Sispro
        {#async function getPersonaApi(dni) {#}
        {#    let response = await fetch('{{ path('buscar_paciente_dni') }}', {#}
        {#        method: 'POST',#}
        {#        headers: {#}
        {#            'Content-Type': 'application/json'#}
        {#        },#}
        {#        body: JSON.stringify({#}
        {#            dni: dni,#}
        {#        })#}
        {#    });#}
        {#    return await response.json();#}
        {#}#}
        {#async function getSocio(dni) {#}
        {#    let response = await fetch(`https://solcafe.sisprocoffee.com/api/v2/socios/${dni}`, {#}
        {#        method: "GET",#}
        {#        headers: {"Content-type": "application/json;charset=UTF-8"}#}
        {#    })#}
        {#        .then(response => response.json())#}
        {#        .catch(err => console.log(err))#}
        {#    return await response;#}
        {#}#}

        function fetchData1(query) {
            return fetch('{{ path('buscar_paciente_dni') }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    dni: query,
                })
            }).then(response => response.json());
        }

        function fetchData2(query) {
            return fetch(`https://solcafe.sisprocoffee.com/api/v2/socios/${query}`)
                .then(response => response.json());
        }

        function compareResults(query) {
            // Realizar ambas consultas fetch en paralelo
            let nombreSispro = null;
            let nombreReniec = null;
            let nombreSelected = null;
            Promise.all([fetchData1(query), fetchData2(query)])
                .then(([data1, data2]) => {
                    nombreReniec = data1.data.nombreCompleto
                    nombreSispro = data2.socio.nombre
                    if (nombreReniec === null && nombreSispro !== null){
                        console.log('No se encontraron datos en Reniec, elegimos el nombreSispro')
                        nombreSelected = nombreSispro;
                        return;
                    }
                    if (nombreReniec === nombreSispro){
                        nombreSelected = nombreReniec;
                        console.log('Elegimos el nombre de Reniec')
                        return;
                    }
                    if (nombreReniec !== nombreSispro && nombreReniec !== null && nombreSispro !== null){
                        console.log('El usuario debe elegir')
                        return;
                    }
                })
                .catch(error => {
                    console.error("Error al obtener datos:", error);
                });
        }

    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            Flatpickr();
            Select2();
            compareResults('27855133');
        })

        // Realiza la busqueda luego de haber escrito 8 dígitos en el DNI
        dniTxt.onkeyup = function () {
            if (this.value.length !== 8) {
                return;
            }
            // compareResults(this.value);
            // // getPersonaApi(this.value).then(result => {
            // //     if (null === result.data){
            // //         return;
            // //     }
            // //     let nombreSocio = result.data.nombreCompleto;
            // //     console.log(nombreSocio);
            // //     // nombresTxt.value = result.data['nombreCompleto']
            // //     //     console.log(result.data);
            // //     // else {
            // //     //     // Muestra alerta si no encuentra algun registro
            // //     //     // Falta implementar Boton para registrar por modal un Paciente en caso de no encontrar
            // //     //     swal.fire("Advertencia!", "No se encontró Registro con el DNI ingresado. ", "warning");
            // //     // }
            // // });
            // baseSocialTxt.value = 'Base Social de Ejemplo';
            // tipoSocioTxt.value = 'Socio';
        }
    </script>
{% endblock %}
